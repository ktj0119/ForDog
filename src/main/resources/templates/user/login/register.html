<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>ForDog - 회원가입 2단계 정보 입력</title>
  <link rel="stylesheet" th:href="@{/css/userInterface.css}"/>
  <link rel="stylesheet" th:href="@{/css/userCommon.css}"/>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <style>
    .register-container {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      flex: 1;
      padding: 10px;
    }

    .register-container h1 {
      font-size: 28px;
      margin-bottom: 30px;
      color: var(--highlight);
    }

    form {
      display: flex;
      flex-direction: column;
    }

    label {
      margin-top: 15px;
      font-weight: 600;
      user-select: text;
    }

    input[type="email"],
    input[type="password"],
    input[type="text"],
    input[type="date"],
    input[type="tel"] {
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      user-select: text;
    }

    input[type="button"] {
      margin-left: 10px;
      padding: 10px 16px;
      background-color: var(--accent);
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    input[type="button"]:hover {
      background-color: var(--accent-dark);
    }

    .btn-area {
      margin: 30px auto 0 auto;
      text-align: center;
    }

    button[type="submit"] {
      padding: 10px 40px;
      background-color: var(--highlight);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    button[type="submit"]:hover {
      background-color: var(--highlight-dark);
    }

    #email-message,
    #password-message {
      height: 22px;
      margin-top: 4px;
      font-weight: 600;
      user-select: text;
    }

    /* 주소 및 성별 inline layout */
    form > div {
      display: flex;
      align-items: center;
      user-select: text;
    }

    form > div > input[type="text"],
    form > div > input[type="email"],
    form > div > input[type="password"],
    form > div > input[type="date"],
    form > div > input[type="tel"] {
      flex: 1;
    }

    /* 성별 라디오 버튼 간격 */
    input[type="radio"] {
      margin-left: 15px;
      margin-right: 5px;
      cursor: pointer;
      margin-top: 15px;
    }

    label[for="male"], label[for="female"] {
      cursor: pointer;
      user-select: none;
    }

    /* 모달 배경 */
    #modal-background {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }

    /* 이메일 인증 모달 */
    #email-modal {
      width: 500px;
      padding: 25px 30px;
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      z-index: 1000;
      text-align: center;
    }

    #email-modal h4 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--highlight);
      font-weight: 700;
      font-size: 1.3rem;
    }

    #email-modal p {
      margin-bottom: 10px;
      color: var(--text-dark);
      font-size: 0.95rem;
    }

    #email-code {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      border-radius: 8px;
      border: 2px solid #000;
      margin-bottom: 12px;
    }

    #email-submit,
    #email-cancel {
      width: auto;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.95rem;
      margin: 5px;
    }

    #email-submit {
      background-color: var(--highlight);
      color: white;
      border: 0;
    }

    #email-submit:hover {
      background-color: var(--highlight-dark);
    }

    #email-cancel {
      background-color: #efefef;
      color: var(--text-dark);
      border: 0;
    }

    #email-cancel:hover {
      background-color: #ccc;
    }

    #email-modal-message {
      height: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
<!-- 헤더 / 네비게이션 -->
<div th:replace="header/userHeader :: userHeader"></div>

<!-- 메인 화면 -->
<main>
  <div class="register-container">
    <h1>회원가입 - 정보 입력</h1>

    <form action="/login/registerProc" method="post" id="submit-form">
      <label for="email">이메일</label>
      <div>
        <input type="email" id="email" name="id" placeholder="이메일을 입력해주세요" required>
        <input type="button" id="email-check" value="인증" title="이메일 인증하기">
      </div>
      <p id="email-message" style="color:red;"></p>

      <label for="password">비밀번호</label>
      <input type="password" id="password" name="pwd"
             pattern="(?=.*[a-zA-Z])(?=.*[0-9])(?=.*[!@#$%^&*])[a-zA-Z0-9!@#$%^&*]{8,20}"
             placeholder="영문, 숫자, 특수문자 포함 8 ~ 20자로 입력해주세요" required>

      <label for="password2">비밀번호 확인</label>
      <div>
        <input type="password" id="password2" name="password2"
               pattern="(?=.*[a-zA-Z])(?=.*[0-9])(?=.*[!@#$%^&*])[a-zA-Z0-9!@#$%^&*]{8,20}" required>
        <input type="button" id="password2-check" value="일치 확인" title="비밀번호 일치 확인">
      </div>
      <p id="password-message" style="color:red;"></p>

      <label for="name">이름</label>
      <input type="text" id="name" name="name" required>

      <label>성별</label>
      <div>
        <input type="radio" id="male" name="gender" value="남성" required>
        <label for="male">남성</label>

        <input type="radio" id="female" name="gender" value="여성">
        <label for="female">여성</label>
      </div>

      <label for="birthDate">생년월일</label>
      <input type="date" id="birthDate" name="birthDate" required>

      <label for="phone">전화번호</label>
      <input type="tel" id="phone" name="phone" pattern="[0-9]{2,3}-[0-9]{3,4}-[0-9]{4}"
             placeholder="예: 02-123-4567 또는 010-1234-5678" required>

      <label for="location_address">주소</label>
      <div>
        <input type="text" id="location_address" name="addressMain" placeholder="주소" required readonly>
        <input type="button" onclick="execDaumPostcode()" value="우편번호 찾기" title="우편번호 찾기">
      </div>
      <input type="text" id="location_detailAddress" name="addressDetail" placeholder="상세주소">

      <div class="btn-area">
        <button type="submit">가입하기</button>
      </div>
    </form>
  </div>
</main>

<!-- 모달 배경 -->
<div id="modal-background"></div>

<!-- 이메일 인증 모달 -->
<div id="email-modal">
  <h4>이메일 인증</h4>
  <p>인증번호를 입력하세요:</p>
  <input type="text" id="email-code" placeholder="인증번호">
  <p id="email-modal-message" style="color:red;"></p>
  <input type="button" id="email-submit" value="확인">
  <input type="button" id="email-cancel" value="취소">
</div>

<!-- 푸터 -->
<div th:replace="header/userFooter :: userFooter"></div>

<!-- 이메일 인증 스크립트 -->
<script>
  const emailInput = document.getElementById('email');
  const emailCheckBtn = document.getElementById('email-check');

  const modalBackground = document.getElementById('modal-background');
  const emailModal = document.getElementById('email-modal');

  const emailSubmit = document.getElementById('email-submit');
  const emailCancel = document.getElementById('email-cancel');

  const emailCode = document.getElementById('email-code');
  const emailMessage = document.getElementById('email-message');
  const emailModalMessage = document.getElementById('email-modal-message');

  let emailVerified = false;

  emailCheckBtn.addEventListener('click', function() {
    const emailValue = emailInput.value.trim();

    if (!emailValue) {
      emailMessage.style.color = "red";
      emailMessage.textContent = "이메일을 입력해주세요.";
      emailInput.focus();
      return;
    }

    if (!emailInput.checkValidity()) {
      emailMessage.style.color = "red";
      emailMessage.textContent = "이메일 형식이 맞지 않습니다.";
      emailInput.focus();
      return;
    }

    const xhrCheck = new XMLHttpRequest();
    xhrCheck.open('GET', `/login/registerCheck?id=${encodeURIComponent(emailValue)}`, true);
    xhrCheck.onreadystatechange = function() {
      if (xhrCheck.readyState !== 4) return;
      if (xhrCheck.status !== 200) return;

      const isExist = xhrCheck.responseText.trim() === "true";
      if (isExist) {
        emailMessage.style.color = "red";
        emailMessage.textContent = "이미 존재하는 아이디입니다.";
        return;
      }

      emailMessage.textContent = "";

      modalBackground.style.display = "block";
      emailModal.style.display = "block";
      emailModalMessage.textContent = "인증번호를 전송 중입니다...";
      emailCode.value = "";
      emailModalMessage.style.color = "red";
      emailCode.focus();

      const xhrMail = new XMLHttpRequest();
      xhrMail.open("POST", "/mail/send", true);
      xhrMail.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhrMail.onreadystatechange = function() {
        if (xhrMail.readyState === 4) {
          if (xhrMail.status === 200 && xhrMail.responseText === "success") {
            emailModalMessage.style.color = "green";
            emailModalMessage.textContent = "인증번호가 전송되었습니다. 이메일을 확인하세요.";
          } else {
            emailModalMessage.style.color = "red";
            emailModalMessage.textContent = "인증번호 전송 실패. 다시 시도해주세요.";
          }
        }
      };
      xhrMail.send("email=" + encodeURIComponent(emailValue));
    };
    xhrCheck.send();
  });

  emailSubmit.addEventListener('click', function() {
    const trimEmailCode = emailCode.value.trim();

    if (!trimEmailCode) {
      emailModalMessage.style.color = "red";
      emailModalMessage.textContent = "인증번호를 입력해주세요.";
      return;
    }

    const xhr = new XMLHttpRequest();
    xhr.open("POST", "/mail/verify", true);
    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4 && xhr.status === 200) {
        if (xhr.responseText === "true") {
          emailMessage.style.color = "green";
          emailMessage.textContent = "이메일 인증 완료";

          emailVerified = true;

          modalBackground.style.display = "none";
          emailModal.style.display = "none";
        } else {
          emailModalMessage.style.color = "red";
          emailModalMessage.textContent = "인증번호가 올바르지 않습니다.";
          emailCode.focus();
        }
      }
    };
    xhr.send("email=" + encodeURIComponent(emailInput.value) + "&code=" + encodeURIComponent(trimEmailCode));
  });

  emailCancel.addEventListener('click', function() {
    modalBackground.style.display = "none";
    emailModal.style.display = "none";
    emailModalMessage.textContent = "";
    emailCode.value = "";
    emailMessage.style.color = "red";
    emailMessage.textContent = "이메일 인증이 취소되었습니다.";
  });
</script>

<!-- 비밀번호 확인 스크립트 -->
<script>
  const password = document.getElementById('password');
  const password2 = document.getElementById('password2');
  const passwordCheckBtn = document.getElementById('password2-check');

  const passwordMessage = document.getElementById('password-message');

  let passwordConfirmed = false;

  passwordCheckBtn.addEventListener('click', function() {
    if (!emailVerified) {
      emailMessage.style.color = "red";
      emailMessage.textContent = "이메일 인증을 완료해주세요.";
      emailInput.focus();
      return;
    }

    if (!password.checkValidity()) {
      passwordMessage.style.color = "red";
      passwordMessage.textContent = "비밀번호 형식이 맞지 않습니다. 영문, 숫자, 특수문자 포함 8~20자로 입력해주세요.";
      passwordConfirmed = false;
      password.focus();
      return;
    }

    if (password.value !== password2.value) {
      passwordMessage.style.color = "red";
      passwordMessage.textContent = "비밀번호가 일치하지 않습니다.";
      passwordConfirmed = false;
      password2.focus();
    } else {
      passwordMessage.style.color = "green";
      passwordMessage.textContent = "비밀번호가 일치합니다.";
      passwordConfirmed = true;
    }
  });
</script>

<!-- 가입 전 인증 확인 스크립트 -->
<script>
  const form = document.getElementById('submit-form');

  form.addEventListener('submit', function(e) {
    e.preventDefault();

    if (!emailVerified) {
      emailMessage.style.color = "red";
      emailMessage.textContent = "이메일 인증을 완료해주세요.";
      emailInput.focus();
      return;
    }

    if (!passwordConfirmed) {
      passwordMessage.style.color = "red";
      passwordMessage.textContent = "비밀번호 확인 버튼을 눌러주세요.";
      password2.focus();
      return;
    }

    form.submit();
  });
</script>

<!-- 다음 주소 API -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
  function execDaumPostcode() {
    new daum.Postcode({
      oncomplete: function(data) {
        let addr = '';
        let extraAddr = '';

        if (data.userSelectedType === 'R') {
          addr = data.roadAddress;
        } else {
          addr = data.jibunAddress;
        }

        if(data.userSelectedType === 'R'){
          if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
            extraAddr += data.bname;
          }

          if(data.buildingName !== '' && data.apartment === 'Y'){
            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
          }

          if(extraAddr !== ''){
            extraAddr = ' (' + extraAddr + ')';
          }
        }

        const fullAddr = addr + ' (' + data.zonecode + ')' + extraAddr;
        document.getElementById("location_address").value = fullAddr;
        document.getElementById("location_detailAddress").focus();
      }
    }).open();
  }
</script>
</body>
</html>
